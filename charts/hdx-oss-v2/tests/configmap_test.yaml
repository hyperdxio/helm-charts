suite: Test ConfigMap
templates:
  - configmaps/app-configmap.yaml
tests:
  - it: should render app configmap correctly
    set:
      hyperdx:
        apiPort: 8000
        appPort: 3000
        appUrl: http://localhost
        logLevel: info
        usageStatsEnabled: true
      mongodb:
        port: 27017
      tasks:
        enabled: false
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: metadata.name
          pattern: -app-config$
      - equal:
          path: data.APP_PORT
          value: "3000"
      - equal:
          path: data.API_PORT
          value: "8000"
      - equal:
          path: data.FRONTEND_URL
          value: "http://localhost:3000"
      - equal:
          path: data.HYPERDX_LOG_LEVEL
          value: "info"
      - equal:
          path: data.USAGE_STATS_ENABLED
          value: "true"
      - equal:
          path: data.CRON_IN_APP_DISABLED
          value: "false"
      - equal:
          path: data.NEXT_PUBLIC_SERVER_URL
          value: "http://localhost:8000"
      - matchRegex:
          path: data.MONGO_URI
          pattern: mongodb://.*-mongodb:27017/hyperdx

  - it: should render NEXT_PUBLIC_SERVER_URL with custom appUrl and apiPort
    set:
      hyperdx:
        apiPort: 9000
        appPort: 4000
        appUrl: https://my-hyperdx.example.com
        logLevel: debug
        usageStatsEnabled: false
      mongodb:
        port: 27017
      tasks:
        enabled: true
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: data.NEXT_PUBLIC_SERVER_URL
          value: "https://my-hyperdx.example.com:9000"
      - equal:
          path: data.FRONTEND_URL
          value: "https://my-hyperdx.example.com:4000"
      - equal:
          path: data.HYPERDX_APP_URL
          value: "https://my-hyperdx.example.com"

  - it: should render NEXT_PUBLIC_SERVER_URL with HTTP URL
    set:
      hyperdx:
        apiPort: 8080
        appPort: 3000
        appUrl: http://192.168.1.100
    asserts:
      - equal:
          path: data.NEXT_PUBLIC_SERVER_URL
          value: "http://192.168.1.100:8080"

  - it: should render NEXT_PUBLIC_SERVER_URL with HTTPS URL
    set:
      hyperdx:
        apiPort: 443
        appPort: 80
        appUrl: https://secure.hyperdx.io
    asserts:
      - equal:
          path: data.NEXT_PUBLIC_SERVER_URL
          value: "https://secure.hyperdx.io:443" 