suite: Test Secrets
templates:
  - secrets.yaml
tests:
  - it: should always render app secrets
    set:
      clickhouse:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-hdx-oss-v2-app-secrets
      - equal:
          path: type
          value: Opaque
      - isNotEmpty:
          path: data.api-key
          
  - it: should render clickhouse secrets when clickhouse is enabled
    set:
      clickhouse:
        enabled: true
        config:
          users:
            appUserPassword: "test-password"
            otelUserPassword: "test-otel-password"
    asserts:
      - hasDocuments:
          count: 2
      - matchSnapshot: {}
          
  - it: should not render clickhouse secrets when clickhouse is disabled
    set:
      clickhouse:
        enabled: false
    asserts:
      - hasDocuments:
          count: 1